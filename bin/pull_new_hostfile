#!/bin/sh
# Create a big hostfile that block most common ad, adware, malware and spying trackers.

set -o errexit
set -o nounset

# Work in tmp dir
cd /tmp || exit 1
# cleanup previous runs
[ -f /tmp/hosts ] && rm -f /tmp/hosts

###############################################################################
## HOSTS
###############################################################################

# All sources are in the form of 127.0.0.1 -> convert to 0.0.0.0 host
wget "https://www.hostsfile.org/Downloads/hosts.txt" -O hostfile0
wget "http://winhelp2002.mvps.org/hosts.txt" -O hostfile1
wget "https://adaway.org/hosts.txt" -O hostfile2
wget "https://pgl.yoyo.org/adservers/serverlist.php?hostformat=hosts&showintro=1&mimetype=plaintext&_=216159" -O hostfile3
wget "https://raw.githubusercontent.com/AdAway/adaway.github.io/master/hosts.txt" -O hostfile4
wget "https://someonewhocares.org/hosts/hosts" -O hostfile5
#
cat hostfile* | sed "s/127\.0\.0\.1/0\.0\.0\.0/g" | sed "s/^#.*//g" | sed "s/https:\/\///g" | sed "s/http:\/\///g" | awk 'NF' >new_hostfile


# All sources are pure hosts list -> convert to 0.0.0.0 host
curl -s "http://mirror1.malwaredomains.com/files/domains.txt" | awk '{print $1}' | sort -u > simplefile0
wget "https://gitlab.com/quidsup/notrack-blocklists/raw/master/notrack-blocklist.txt" -O simplefile1
wget "https://gitlab.com/quidsup/notrack-blocklists/raw/master/notrack-malware.txt" -O simplefile2
wget "https://s3.amazonaws.com/lists.disconnect.me/simple_ad.txt" -O simplefile3
wget "https://s3.amazonaws.com/lists.disconnect.me/simple_malvertising.txt" -O simplefile4
wget "https://s3.amazonaws.com/lists.disconnect.me/simple_malware.txt" -O simplefile5
wget "https://s3.amazonaws.com/lists.disconnect.me/simple_tracking.txt" -O simplefile6
wget "https://v.firebog.net/hosts/Easylist.txt" -O simplefile7
wget "https://v.firebog.net/hosts/Easyprivacy.txt" -O simplefile8
#
cat simplefile* | sed "s/^Mal.*//g" | sed "s/#.*//g" | sed "s/https:\/\///g" | sed "s/http:\/\///g" | awk 'NF' | awk '{print "0.0.0.0 " $0}' >new_simplefile

###############################################################################
## TRACKERS
###############################################################################
#
# Scrape exodus-privacy.org project to pull all the android trackers known
TRACKERS=$(curl -s 'https://reports.exodus-privacy.eu.org/en/trackers/' | grep -Eo "href=\"/en/trackers/[0-9].*/" | sort -u)
FILE=/tmp/trackers.list
[ -f $FILE ] && rm -f $FILE

for i in $TRACKERS; do
	tracker="https://reports.exodus-privacy.eu.org/"$(echo "$i" | cut -d '"' -f2)
	echo "$tracker"
	curl -s "$tracker" | grep "Network detection" | grep -oP '(?<=<code>).*?(?=</code>)' >>"$FILE"
done
for i in $(cat $FILE | sed 's/|/\n/g' | sed 's/ //g' | sed 's/\\//g' | grep -Eo "^[a-zA-Z0-9].*" | sort -u | grep -v "NC$"); do
	echo 0.0.0.0 "$i" >>/tmp/new_trackerfile
done
[ -f "$FILE" ] && rm -f "$FILE"

###############################################################################

# Whitelist some links to make it work on basic services
cat new_simplefile new_hostfile new_trackerfile |
	grep -v tiqcdn |
	grep -v tealiumiq |
	grep -v "::" |
	grep -v "255.255.255.255" |
	sed 's/#.*//g' |
	sed 's/  / /g' |
	sed 's/\t/ /g' |
	sed 's/[[:space:]]*$//' |
	sed "/^ *$/d" |
	sed '/^$/d' |
	sort -u >>tmp_hosts

cat tmp_hosts > hosts
# Make it also IPV6
cat tmp_hosts | sed 's/0\.0\.0\.0/::1/g' >> hosts

# Cleanup
rm -f new_simplefile new_hostfile new_trackerfile tmp_hosts simplefile* hostfile*
#
