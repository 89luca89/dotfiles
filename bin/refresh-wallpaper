#!/bin/sh
#
# refresh-wallpaper: pull latest nice wallpapers from reddit.

set -o errexit
set -o nounset

array="BackgroundArt BeachPorn BotanicalPorn CityPorn EarthPorn LakePorn SkyPorn SpacePorn VillagePorn WQHD_Wallpaper WallPapersHQ WaterPorn WeatherPorn minimalist_art topwalls ultrahdwallpapers wallpaper wallpapers wallpaperdump multiwall"

saveDir="$HOME/.local/share/backgrounds/"
tempDir="/tmp/"
CURRENT_WALLPAPER=$saveDir$(gsettings get org.gnome.desktop.background picture-uri | xargs basename)
for i in $array; do
	URL=$(wget -O - http://www.reddit.com/r/"$i"/top/.rss 2>>/dev/null | grep -Eo "https://?[^&]+jpg" | grep -v "thumbs")
	COUNT=0
	for l in $URL; do
		COUNT=$((COUNT + 1))
		if [ $COUNT -gt 3 ]; then
			COUNT=0
			break
		fi
		NAME="Wallpaper-Reddit-$i-$COUNT.jpg"
		TEMP_FILE=$tempDir$NAME
		echo "$NAME"
		wget "$l" -O "$TEMP_FILE" 2>>/dev/null
		if [ "$saveDir$NAME" = "$CURRENT_WALLPAPER" ]; then
			# When we reach the same name of the current wallpaper, save
			# the new one with another name
			if [ "$(md5sum "$CURRENT_WALLPAPER" | cut -d" " -f1)" != \
				"$(md5sum "$TEMP_FILE" | cut -d" " -f1)" ]; then
				NAME="Wallpaper-Reddit-$i-$COUNT-new.jpg"
			else
				echo "$NAME | Found Same Wallpaper"
				continue
			fi
		fi
		mv "$TEMP_FILE" "$saveDir$NAME"
	done
done
gnome-control-center background 2>>/dev/null &
