#!/bin/sh
# Sync target app via syncthing.
# Create tar.xz of app config/data folder and protect it with gpg.

set -o errexit
# set -o nounset

app_sync() {
	TARGET=$1
	if [ -z $2 ]; then
		echo -n Password:
		read -s password
		echo
	else
		password=$2
	fi
	case "$TARGET" in
	"gpg")
		[ -d ~/.gnupg ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar cf - .gnupg | xz -T 0 -9e >/tmp/gnupg-keys.tar.xz
		gpg --passphrase "$password" --yes --batch --output /tmp/gnupg-keys.tar.xz.gpg --symmetric /tmp/gnupg-keys.tar.xz
		shred -n 25 -u -z /tmp/gnupg-keys.tar.xz
		mv /tmp/gnupg-keys.tar.xz.gpg ~/Syncthing/Secured/
		;;
	"pass")
		[ -d ~/.password-store ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar cf - .password-store | xz -T 0 -9e >/tmp/pass-store.tar.xz
		gpg --passphrase "$password" --yes --batch --output /tmp/pass-store.tar.xz.gpg --symmetric /tmp/pass-store.tar.xz
		shred -n 25 -u -z /tmp/pass-store.tar.xz
		mv /tmp/pass-store.tar.xz.gpg ~/Syncthing/Secured/
		;;
	"xfce4")
		[ -d ~/.config/xfce4 ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar cf - .config/xfce4/ .config/Thunar .config/Mousepad | xz -T 0 -9e >~/dotfiles/xfce/xfce4-setup.tar.xz
		git -C ~/dotfiles commit -m "xfce4: update settings" xfce/xfce4-setup.tar.xz
		;;
	"gnome")
		mkdir /tmp/bkp
		cd /tmp/bkp || exit 1
		for f in $(dconf list /org/gnome/ | grep -v login); do
			dconf dump /org/gnome/$f >org.gnome.$(echo $f | cut -d'/' -f1).conf
		done
		tar cf - /tmp/bkp | xz -T 0 -9e > ~/dotfiles/gnome/gnome-setup.tar.xz
		rm -rf /tmp/bkp
		git -C ~/dotfiles commit -m "xfce4: update settings" gnome/gnome-setup.tar.xz
		;;
	"pidgin")
		[ -d ~/.purple ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar --exclude=*downloads* --exclude=.git --exclude=icons --exclude=logs -c -f - .purple | xz -T 0 -9e >/tmp/pidgin-profile.tar.xz
		gpg --passphrase "$password" --yes --batch --output /tmp/pidgin-profile.tar.xz.gpg --symmetric /tmp/pidgin-profile.tar.xz
		shred -n 25 -u -z /tmp/pidgin-profile.tar.xz
		mv /tmp/pidgin-profile.tar.xz.gpg ~/Syncthing/Secured/
		;;
	"firefox")
		[ -d ~/.mozilla ] || (echo "No folder to backup" && exit 1)
		find ~/.mozilla/ -iname "*cache*" | xargs rm -rf
		find .mozilla/firefox/*/storage/default/http* -iname "*.files" | xargs rm -rf
		cd ~ || exit 1
		tar cf - .mozilla | xz -T 0 -9e >/tmp/firefox-profile.tar.xz
		gpg --passphrase "$password" --yes --batch --output /tmp/firefox-profile.tar.xz.gpg --symmetric /tmp/firefox-profile.tar.xz
		shred -n 25 -u -z /tmp/firefox-profile.tar.xz
		mv /tmp/firefox-profile.tar.xz.gpg ~/Syncthing/Secured/
		;;
	"thunderbird")
		[ -d ~/.thunderbird ] || (echo "No folder to backup" && exit 1)
		find ~/.thunderbird/ -iname "*cache*" | xargs rm -rf
		cd ~ || exit 1
		tar cf - --exclude=.thunderbird/*/extensions/lang* --exclude=.thunderbird/*-default/ImapMail .thunderbird/ | xz -T 0 -9e >/tmp/thunderbird-profile.tar.xz
		gpg --passphrase "$password" --yes --batch --output /tmp/thunderbird-profile.tar.xz.gpg --symmetric /tmp/thunderbird-profile.tar.xz
		shred -n 25 -u -z /tmp/thunderbird-profile.tar.xz
		mv /tmp/thunderbird-profile.tar.xz.gpg ~/Syncthing/Secured/
		;;
	"geary")
		[ -d ~/.config/geary ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar cf - .config/geary/ | xz -T 0 -9e >/tmp/geary-profile.tar.xz
		gpg --passphrase "$password" --yes --batch --output /tmp/geary-profile.tar.xz.gpg --symmetric /tmp/geary-profile.tar.xz
		shred -n 25 -u -z /tmp/geary-profile.tar.xz
		mv /tmp/geary-profile.tar.xz.gpg ~/Syncthing/Secured/
		;;
	"syncthing")
		[ -d ~/.config/syncthing ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar cf - .config/syncthing/ | xz -T 0 -9e >/tmp/syncthing-profile-$(hostname).tar.xz
		mv /tmp/syncthing-profile-$(hostname).tar.xz ~/Syncthing/Secured/
		;;
	esac
}

#
app_restore() {
	TARGET=$1
	case "$TARGET" in
	"gpg")
		gpg --output /tmp/gnupg-keys.tar.xz --decrypt ~/Syncthing/Secured/gnupg-keys.tar.xz.gpg
		if [ ! -f /tmp/gnupg-keys.tar.xz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.gnupg
		xz -T 0 -dc /tmp/gnupg-keys.tar.xz | tar x -C ~/
		shred -n 25 -u -z /tmp/gnupg-keys.tar.xz
		;;
	"pass")
		gpg --output /tmp/pass-store.tar.xz --decrypt ~/Syncthing/Secured/pass-store.tar.xz.gpg
		if [ ! -f /tmp/pass-store.tar.xz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.password-store
		xz -T 0 -dc /tmp/pass-store.tar.xz | tar x -C ~/
		shred -n 25 -u -z /tmp/pass-store.tar.xz
		;;
	"pidgin")
		gpg --output /tmp/pidgin-profile.tar.xz --decrypt ~/Syncthing/Secured/pidgin-profile.tar.xz.gpg
		if [ ! -f /tmp/pidgin-profile.tar.xz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.purple
		xz -T 0 -dc /tmp/pidgin-profile.tar.xz | tar x -C ~/
		shred -n 25 -u -z /tmp/pidgin-profile.tar.xz
		;;
	"gnome")
		rm -rf /tmp/bkp
		xz -T 0 -dc ~/dotfiles/gnome/gnome-setup.tar.xz | tar x -C /
		cd /tmp/bkp || exit 1
		for file in *; do
			dconf_path=$(echo '/'$file | sed 's/\.conf/\//g' | sed 's/\./\//g')
			dconf load $dconf_path < $file
		done
		rm -rf /tmp/bkp
		;;
	"xfce4")
		rm -rf ~/.config/xfce4 ~/.config/Thunar ~/.config/Mousepad
		xz -T 0 -dc ~/dotfiles/xfce/xfce4-setup.tar.xz | tar x -C ~/
		killall -9 xfconfd || true
		killall -9 xfce4-panel || true
		killall -9 thunar || true
		killall -9 xfce4-volumed-pulse || true
		killall -9 xfdesktop || true
		killall -9 xfce4-power-manager || true
		killall -9 xfce4-notifyd || true
		nohup xfce4-power-manager &
		nohup xfce4-panel &
		nohup /usr/lib64/xfce4/notifyd/xfce4-notifyd &
		nohup xfce4-volumed-pulse &
		nohup xfwm4 --replace &
		;;
	"firefox")
		gpg --output /tmp/firefox-profile.tar.xz --decrypt ~/Syncthing/Secured/firefox-profile.tar.xz.gpg
		if [ ! -f /tmp/firefox-profile.tar.xz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.mozilla
		xz -T 0 -dc /tmp/firefox-profile.tar.xz | tar x -C ~/
		shred -n 25 -u -z /tmp/firefox-profile.tar.xz
		;;
	"thunderbird")
		gpg --output /tmp/thunderbird-profile.tar.xz --decrypt ~/Syncthing/Secured/thunderbird-profile.tar.xz.gpg
		if [ ! -f /tmp/thunderbird-profile.tar.xz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.thunderbird
		xz -T 0 -dc /tmp/thunderbird-profile.tar.xz | tar x -C ~/
		shred -n 25 -u -z /tmp/thunderbird-profile.tar.xz
		;;
	"geary")
		gpg --output /tmp/geary-profile.tar.xz --decrypt ~/Syncthing/Secured/geary-profile.tar.xz.gpg
		if [ ! -f /tmp/geary-profile.tar.xz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.config/geary
		xz -T 0 -dc /tmp/geary-profile.tar.xz | tar x -C ~/
		shred -n 25 -u -z /tmp/geary-profile.tar.xz
		;;
	esac
}

if [ "$1" = "sync" ]; then
	shift 1
	app_sync $@
elif [ "$1" = "restore" ]; then
	shift 1
	app_restore $@
else
	echo "Example: sync_app sync firefox"
	echo "Example: sync_app restore firefox"
	echo ""
fi
