#!/bin/sh
# Sync target app via syncthing.
# Create tar.gz of app config/data folder and protect it with gpg.

set -o errexit
# set -o nounset

declare -a GNOME_BACKUP=(
	"desktop"
	"settings-daemon"
	"shell"
	"terminal"
)

app_sync() {
	TARGET=$1
	if [ -z $2 ] && [ "$TARGET" != "xfce4" ] && [ "$TARGET" != "gnome" ]; then
		echo -n "Password: "
		read -s password
		echo
		echo -n "Retype Password: "
		read -s password_2
		echo

		if [ "$password" != "$password_2" ]; then
			echo pass mismatch
			exit 1
		fi

	else
		password=$2
	fi
	case "$TARGET" in
	"ssh")
		[ -d ~/.ssh ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar -czf /tmp/ssh-keys.tar.gz .ssh
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/ssh-keys.tar.gz -out /tmp/ssh-keys.tar.gz.enc -k "$password"
		shred -n 25 -u -z /tmp/ssh-keys.tar.gz
		cp /tmp/ssh-keys.tar.gz.enc ~/Syncthing/Secured/
		;;
	"gnome")
		mkdir /tmp/bkp
		cd /tmp/bkp || exit 1
		for f in ${GNOME_BACKUP[@]}; do
			dconf dump /org/gnome/$f/ >org.gnome.$f.conf
		done
		tar -czf ~/dotfiles/_desktop/gnome-setup.tar.gz /tmp/bkp # "$HOME"/.local/share/gnome-shell/extensions/
		rm -rf /tmp/bkp
		git -C ~/dotfiles commit -m "gnome: update settings" _desktop/gnome-setup.tar.gz
		;;
	"firefox")
		[ -d ~/.mozilla ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		find .mozilla -type d -iname "*cache*" | xargs rm -rf
		tar -c -z -f /tmp/firefox-profile.tar.gz --exclude="*cache*" --exclude=".mozilla/firefox/*/storage/default/http*" .mozilla
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/firefox-profile.tar.gz -out /tmp/firefox-profile.tar.gz.enc -k "$password"
		shred -n 25 -u -z /tmp/firefox-profile.tar.gz
		mv /tmp/firefox-profile.tar.gz.enc ~/Syncthing/Secured/
		;;
	"thunderbird")
		[ -d ~/.thunderbird ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar -c -z -f /tmp/thunderbird-profile.tar.gz --exclude="*cache*" --exclude=.thunderbird/*/extensions/lang* --exclude=.thunderbird/*-default/ImapMail .thunderbird/
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/thunderbird-profile.tar.gz -out /tmp/thunderbird-profile.tar.gz.enc -k "$password"
		shred -n 25 -u -z /tmp/thunderbird-profile.tar.gz
		mv /tmp/thunderbird-profile.tar.gz.enc ~/Syncthing/Secured/
		;;
	"chromium")
		[ -d ~/.config/chromium ] || (echo "No folder to backup" && exit 1)
		# pgrep chromium > /dev/null && (echo "Shutdown chrome before backup" && exit 1)
		cd ~ || exit 1
		tar --exclude=*Cache* -czf /tmp/chromium-profile.tar.gz .config/chromium .local/share/applications/chromium-freeworld.desktop bin/chromium-freeworld
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/chromium-profile.tar.gz -out /tmp/chromium-profile.tar.gz.enc -k "$password"
		shred -n 25 -u -z /tmp/chromium-profile.tar.gz
		mv /tmp/chromium-profile.tar.gz.enc ~/Syncthing/Secured/
		;;
	"syncthing")
		[ -d ~/.config/syncthing ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar -czf /tmp/syncthing-profile-$(hostname).tar.gz .config/syncthing/
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/syncthing-profile-$(hostname).tar.gz -out /tmp/syncthing-profile-$(hostname).tar.gz.enc -k "$password"
		shred -n 25 -u -z /tmp/syncthing-profile-$(hostname).tar.gz
		mv /tmp/syncthing-profile-$(hostname).tar.gz.enc ~/Syncthing/Secured/
		;;
	"tg")
		[ -d ~/.config/tg ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar --exclude=files -c -z -f /tmp/tg-profile.tar.gz .config/tg .cache/tg
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/tg-profile.tar.gz -out /tmp/tg-profile.tar.gz.enc -k "$password"
		shred -n 25 -u -z /tmp/tg-profile.tar.gz
		mv /tmp/tg-profile.tar.gz.enc ~/Syncthing/Secured/
		;;
	"weechat")
		[ -d ~/.weechat ] || (echo "No folder to backup" && exit 1)
		cd ~ || exit 1
		tar -c -z -f /tmp/weechat-profile.tar.gz .weechat
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/weechat-profile.tar.gz -out /tmp/weechat-profile.tar.gz.enc -k "$password"
		shred -n 25 -u -z /tmp/weechat-profile.tar.gz
		mv /tmp/weechat-profile.tar.gz.enc ~/Syncthing/Secured/
		;;
	"flatpak")
		[ -d ~/.var/app ] || (echo "No folder to backup" && exit 1)
		cd ~/.var || exit 1
		tar --exclude=*cache* -c -z -f /tmp/flatpak-data.tar.gz app
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/flatpak-data.tar.gz -out /tmp/flatpak-data.tar.gz.enc -k "$password"
		shred -n 25 -u -z /tmp/flatpak-data.tar.gz
		mv /tmp/flatpak-data.tar.gz.enc ~/Syncthing/Secured/
		;;
	"connections")
		[ -d /etc/NetworkManager/system-connections/ ] || (echo "No folder to backup" && exit 1)
		[ -d /var/lib/bluetooth/ ] || (echo "No folder to backup" && exit 1)
		cd / || exit 1
		sudo tar -c -z -f /tmp/system-connections.tar.gz /etc/NetworkManager/system-connections/ /var/lib/bluetooth/
		sudo chown $USER. /tmp/system-connections.tar.gz
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/system-connections.tar.gz -out /tmp/system-connections.tar.gz.enc -k "$password"
		sudo shred -n 25 -u -z /tmp/system-connections.tar.gz
		mv /tmp/system-connections.tar.gz.enc ~/Syncthing/Secured/
		;;
	esac
}

#
app_restore() {
	TARGET=$1
	case "$TARGET" in
	"ssh")
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/ssh-keys.tar.gz.enc -out /tmp/ssh-keys.tar.gz
		if [ ! -f /tmp/ssh-keys.tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		tar -xzf /tmp/ssh-keys.tar.gz -C ~/
		shred -n 25 -u -z /tmp/ssh-keys.tar.gz
		;;
	"gnome")
		rm -rf /tmp/bkp "$HOME"/.local/share/gnome-shell/extensions/
		tar -xzf ~/dotfiles/_desktop/gnome-setup.tar.gz -C /
		cd /tmp/bkp || exit 1
		for file in *; do
			dconf_path=$(echo '/'$file | sed 's/\.conf/\//g' | sed 's/\./\//g')
			dconf load $dconf_path <$file
		done
		rm -rf /tmp/bkp
		;;
	"firefox")
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/firefox-profile.tar.gz.enc -out /tmp/firefox-profile.tar.gz
		if [ ! -f /tmp/firefox-profile.tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.mozilla
		tar -xzf /tmp/firefox-profile.tar.gz -C ~/
		shred -n 25 -u -z /tmp/firefox-profile.tar.gz
		;;
	"chromium")
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/chromium-profile.tar.gz.enc -out /tmp/chromium-profile.tar.gz
		if [ ! -f /tmp/chromium-profile.tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.config/chromium
		tar -xzf /tmp/chromium-profile.tar.gz -C ~/
		shred -n 25 -u -z /tmp/chromium-profile.tar.gz
		;;
	"thunderbird")
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/thunderbird-profile.tar.gz.enc -out /tmp/thunderbird-profile.tar.gz
		if [ ! -f /tmp/thunderbird-profile.tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.thunderbird
		tar -xzf /tmp/thunderbird-profile.tar.gz -C ~/
		shred -n 25 -u -z /tmp/thunderbird-profile.tar.gz
		;;
	"syncthing")
		systemctl stop --user syncthing
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/syncthing-profile-$(hostname).tar.gz.enc -out /tmp/syncthing-profile-$(hostname).tar.gz
		if [ ! -f /tmp/syncthing-profile-$(hostname).tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.config/syncthing
		tar -xzf /tmp/syncthing-profile-$(hostname).tar.gz -C ~/
		shred -n 25 -u -z /tmp/syncthing-profile-$(hostname).tar.gz
		systemctl restart --user syncthing
		;;
	"tg")
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/tg-profile.tar.gz.enc -out /tmp/tg-profile.tar.gz
		if [ ! -f /tmp/tg-profile.tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		tar -xzf /tmp/tg-profile.tar.gz -C ~/
		shred -n 25 -u -z /tmp/tg-profile.tar.gz
		;;
	"weechat")
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/weechat-profile.tar.gz.enc -out /tmp/weechat-profile.tar.gz
		if [ ! -f /tmp/weechat-profile.tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		tar -xzf /tmp/weechat-profile.tar.gz -C ~/
		shred -n 25 -u -z /tmp/weechat-profile.tar.gz
		;;
	"flatpak")
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/flatpak-data.tar.gz.enc -out /tmp/flatpak-data.tar.gz
		if [ ! -f /tmp/flatpak-data.tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		rm -rf ~/.var/app
		tar -xzf /tmp/flatpak-data.tar.gz -C ~/.var/
		shred -n 25 -u -z /tmp/flatpak-data.tar.gz
		;;
	"connections")
		openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/Secured/system-connections.tar.gz.enc -out /tmp/system-connections.tar.gz
		if [ ! -f /tmp/system-connections.tar.gz ]; then
			echo "Failed to decrypt"
			exit 1
		fi
		sudo tar -xzf /tmp/system-connections.tar.gz -C /
		shred -n 25 -u -z /tmp/system-connections.tar.gz
		sudo systemctl restart NetworkManager
		;;
	esac
}

if [ "$1" = "sync" ]; then
	shift 1
	app_sync $@
elif [ "$1" = "restore" ]; then
	shift 1
	app_restore $@
else
	echo "Example: sync_app sync firefox"
	echo "Example: sync_app restore firefox"
	echo ""
fi
