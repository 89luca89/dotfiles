#!/usr/bin/env bash
# Sync target app via syncthing.
# Create tar.gz of app config/data folder and protect it with gpg.

set -o errexit
# set -o nounset

app_sync() {
	TARGET=$1
	if [ -z $2 ]; then
		echo -n "Password: "
		read -s password
		echo
		echo -n "Retype Password: "
		read -s password_2
		echo

		if [ "$password" != "$password_2" ]; then
			echo pass mismatch
			exit 1
		fi

	else
		password=$2
	fi
	case "$TARGET" in
		"gpg")
			[ -d ~/.gnupg ] || (echo "No folder to backup" && exit 1)
			cd ~ || exit 1
			tar -czf /tmp/gnupg-keys.tar.gz .gnupg
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/gnupg-keys.tar.gz -out /tmp/gnupg-keys.tar.gz.enc -k "$password"
			shred -n 25 -u -z /tmp/gnupg-keys.tar.gz
			cp /tmp/gnupg-keys.tar.gz.enc ~/Syncthing/secured/
			;;
		"ssh")
			[ -d ~/.ssh ] || (echo "No folder to backup" && exit 1)
			cd ~ || exit 1
			tar -czf /tmp/ssh-keys.tar.gz .ssh
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/ssh-keys.tar.gz -out /tmp/ssh-keys.tar.gz.enc -k "$password"
			shred -n 25 -u -z /tmp/ssh-keys.tar.gz
			cp /tmp/ssh-keys.tar.gz.enc ~/Syncthing/secured/
			;;
		"firefox")
			[ -d ~/.var/app/org.mozilla.firefox/.mozilla ] || (echo "No folder to backup" && exit 1)
			cd ~ || exit 1
			tar --exclude=http* --exclude=*favicons* -czf /tmp/firefox-profile.tar.gz .var/app/org.mozilla.firefox/.mozilla
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/firefox-profile.tar.gz -out /tmp/firefox-profile.tar.gz.enc -k "$password"
			shred -n 25 -u -z /tmp/firefox-profile.tar.gz
			mv /tmp/firefox-profile.tar.gz.enc ~/Syncthing/secured/
			;;
		"chromium")
			[ -d ~/.var/app/org.chromium.Chromium/config/chromium/ ] || (echo "No folder to backup" && exit 1)
			# pgrep chromium > /dev/null && (echo "Shutdown chrome before backup" && exit 1)
			cd ~ || exit 1
			tar --exclude=*Cache* --exclude=*IndexedDB* -czf /tmp/chromium-profile.tar.gz .var/app/org.chromium.Chromium/config/chromium/ .local/share/applications/*hromium*.desktop bin/chromium-freeworld
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/chromium-profile.tar.gz -out /tmp/chromium-profile.tar.gz.enc -k "$password"
			shred -n 25 -u -z /tmp/chromium-profile.tar.gz
			mv /tmp/chromium-profile.tar.gz.enc ~/Syncthing/secured/
			;;
		"flatpak")
			[ -d ~/.var/app ] || (echo "No folder to backup" && exit 1)
			cd ~/.var || exit 1
			tar --exclude=*cache* --exclude={*firefox*,*Chromium*,*Webkit*,*Cache*,*Cockatrice*,*PCSX*} -c -z -f /tmp/flatpak-data.tar.gz app
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -in /tmp/flatpak-data.tar.gz -out /tmp/flatpak-data.tar.gz.enc -k "$password"
			shred -n 25 -u -z /tmp/flatpak-data.tar.gz
			mv /tmp/flatpak-data.tar.gz.enc ~/Syncthing/secured/
			;;
	esac
}

#
app_restore() {
	TARGET=$1
	case "$TARGET" in
		"gpg")
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/secured/gnupg-keys.tar.gz.enc -out /tmp/gnupg-keys.tar.gz
			if [ ! -f /tmp/gnupg-keys.tar.gz ]; then
				echo "Failed to decrypt"
				exit 1
			fi
			tar -xzf /tmp/gnupg-keys.tar.gz -C ~/
			shred -n 25 -u -z /tmp/gnupg-keys.tar.gz
			;;
		"ssh")
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/secured/ssh-keys.tar.gz.enc -out /tmp/ssh-keys.tar.gz
			if [ ! -f /tmp/ssh-keys.tar.gz ]; then
				echo "Failed to decrypt"
				exit 1
			fi
			tar -xzf /tmp/ssh-keys.tar.gz -C ~/
			shred -n 25 -u -z /tmp/ssh-keys.tar.gz
			;;
		"firefox")
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/secured/firefox-profile.tar.gz.enc -out /tmp/firefox-profile.tar.gz
			if [ ! -f /tmp/firefox-profile.tar.gz ]; then
				echo "Failed to decrypt"
				exit 1
			fi
			rm -rf ~/.var/app/org.mozilla.firefox/
			tar -xzf /tmp/firefox-profile.tar.gz -C ~/
			shred -n 25 -u -z /tmp/firefox-profile.tar.gz
			;;
		"chromium")
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/secured/chromium-profile.tar.gz.enc -out /tmp/chromium-profile.tar.gz
			if [ ! -f /tmp/chromium-profile.tar.gz ]; then
				echo "Failed to decrypt"
				exit 1
			fi
			rm -rf ~/.var/app/org.chromium.Chromium
			tar -xzf /tmp/chromium-profile.tar.gz -C ~/
			shred -n 25 -u -z /tmp/chromium-profile.tar.gz
			;;
		"flatpak")
			openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -d -in ~/Syncthing/secured/flatpak-data.tar.gz.enc -out /tmp/flatpak-data.tar.gz
			if [ ! -f /tmp/flatpak-data.tar.gz ]; then
				echo "Failed to decrypt"
				exit 1
			fi
			rm -rf ~/.var/app
			tar -xzf /tmp/flatpak-data.tar.gz -C ~/.var/
			shred -n 25 -u -z /tmp/flatpak-data.tar.gz
			;;
	esac
}

if [ "$1" = "sync" ]; then
	shift 1
	app_sync $@
elif [ "$1" = "restore" ]; then
	shift 1
	app_restore $@
else
	echo "Example: sync_app sync firefox"
	echo "Example: sync_app restore firefox"
	echo ""
fi
