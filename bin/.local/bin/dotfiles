#!/usr/bin/env bash

if ! cd "$HOME/dotfiles" > /dev/null; then
	exit 1
fi

for i in $(ls -d */ | grep -vE "^_"); do
	pushd $i > /dev/null || return
	for j in $(find . -type f); do
		destfile="$(echo "$j" | sed "s|\./|$HOME/|g")"
		if [ ! -L "$destfile" ]; then
			rm -i "$destfile"
		fi
		echo "$destfile"
		mkdir -p "$(dirname "${destfile}")"
		ln -sf "$(realpath "$j")" "$destfile"
	done
	popd > /dev/null || return
done

# Cleanup broken symlinks
find -L $HOME \
	-path "$HOME/.local/share/flatpak" -prune \
	-o \
	-path "$HOME/.local/share/containers" -prune \
	-o \
	-type l -print | xargs rm
