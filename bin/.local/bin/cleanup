#!/bin/bash
# Using bash instead of posix sh, to use arrays

# -y don't ask anything
if [[ $1 == "-y" ]]; then
	G_SURE="y"
else
	G_SURE="n"
fi

read_bool_config() {
	question=$1
	default=$2
	expected=$3

	while true; do
		read -p "$question  [$default]: " result
		if [ ! -z "$result" ]; then
			if [ ! -z "$expected" ]; then
				if [[ $result =~ ^[yYnN]$ ]]; then
					break
				else
					echo >&2 "Please reply Y or N."
				fi
			fi
		elif [ ! -z "$default" ]; then
			result=$default
			break
		fi
	done
	echo $result
}

clean_folder() {
	dir=$1
	if [[ ! $G_SURE =~ ^[yY]$ ]]; then
		SURE=$(read_bool_config "Delete $dir? Y/N" "N" "Y or N")
	else
		SURE=$G_SURE
	fi
	if [[ $SURE =~ ^[yY]$ ]]; then
		rm -rf $dir
	fi
}

FOLDERS=(
	"./.cache"
	"./.config"
	"./.gnupg"
	"./.local"
	"./.mozilla"
	"./.ssh"
	"./.thunderbird"
	"./.var"
	"./.vim"
	"./Books"
	"./Desktop"
	"./Documents"
	"./Downloads"
	"./Games"
	"./Music"
	"./PhoneCamera"
	"./Pictures"
	"./Programs"
	"./Projects"
	"./Public"
	"./Syncthing"
	"./Templates"
	"./Videos"
	"./VirtualMachines"
	"./bin"
	"./dotfiles"
)
pushd ~/ || exit 127
find . -maxdepth 1 -type d -empty -delete
for dir in $(find . -maxdepth 1 -type d | tail -n+2); do
	if [[ ! " ${FOLDERS[@]} " =~ " ${dir} " ]]; then
		clean_folder "$dir"
	fi
done
popd || exit 1

CONFIG_FOLDERS=(
	"./autostart"
	"./chromium"
	"./cni"
	"./containers"
	"./dconf"
	"./gnome-control-center"
	"./gnome-session"
	"./goa-1.0"
	"./gtk-2.0"
	"./gtk-3.0"
	"./gtk-4.0"
	"./ibus"
	"./libvirt"
	"./nautilus"
	"./pipewire"
	"./pulse"
	"./systemd"
	"./mpv"
)
pushd ~/.config || exit 127
find . -maxdepth 1 -type d -empty -delete
for dir in $(find . -maxdepth 1 -type d | tail -n+2); do
	if [[ ! " ${CONFIG_FOLDERS[@]} " =~ " ${dir} " ]]; then
		clean_folder "$dir"
	fi
done
popd || exit 1

LOCAL_FOLDERS=(
	"./applications"
	"./backgrounds"
	"./bash-completion"
	"./containers"
	"./flatpak"
	"./go"
	"./gnome-settings-daemon"
	"./gnome-shell"
	"./gvfs-metadata"
	"./icc"
	"./icons"
	"./keyrings"
	"./man"
	"./nautilus"
	"./systemd"
	"./xorg"
)

pushd ~/.local/share || exit 127
find . -maxdepth 1 -type d -empty -delete
for dir in $(find . -maxdepth 1 -type d | tail -n+2); do
	if [[ ! " ${LOCAL_FOLDERS[@]} " =~ " ${dir} " ]]; then
		clean_folder "$dir"
	fi
done
popd || exit 1

FLATS="$(flatpak list --app --columns=application) citrix"
for d in ~/.var/app/*; do
	DIR=$(basename "$d")
	if ! echo $FLATS | grep -q $DIR; then
		clean_folder "$d"
	fi
done

for i in $(find ~ -type l -o -path ~/.local/share/flatpak -prune -o -path ~/.local/share/containers -prune); do
	if ! test -e "$i"; then
		ls -l --color "$i"
		clean_folder "$i"
	fi
done
