---
# tasks file for dotfiles

- name: Check if Baseline folder is present
  file:
    path: '{{ item }}'
    state: directory
  with_items:
    - '{{ ansible_env.HOME }}/.vim'
    - '{{ ansible_env.HOME }}/.vim/swap'
    - '{{ ansible_env.HOME }}/.vim/undo'
    - '{{ ansible_env.HOME }}/.vim/view'
    - '{{ ansible_env.HOME }}/.vim/syntax'
    - '{{ ansible_env.HOME }}/.vim/autoload'
    - '{{ ansible_env.HOME }}/.local/go'
    - '{{ ansible_env.HOME }}/.local/rust'
    - '{{ ansible_env.HOME }}/.config/mpv'
    - '{{ ansible_env.HOME }}/.config/keepassxc'
    - '{{ ansible_env.HOME }}/.config/systemd'
    - '{{ ansible_env.HOME }}/Programs'
    - '{{ ansible_env.HOME }}/.config/systemd/user'
  register: firstrun

- name: Download Dotfiles
  git:
    repo: https://github.com/89luca89/dotfiles
    dest: '{{ ansible_env.HOME }}/dotfiles'
    version: master
    update: true

- name: Install scripts before starting dotfiles
  get_url:
    url: '{{ item.src }}'
    dest: '{{ item.dest }}'
    mode: 0755
  with_items:
    - { src: "https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim", dest: '{{ ansible_env.HOME }}/.vim/autoload' }

- name: Prepare to link dotfiles
  file:
    path: '{{ item }}'
    state: absent
  with_items:
    - '{{ ansible_env.HOME }}/.ansible.cfg'
    - '{{ ansible_env.HOME }}/.aliases'
    - '{{ ansible_env.HOME }}/.bashrc'
    - '{{ ansible_env.HOME }}/.histfile'
    - '{{ ansible_env.HOME }}/.tmux.conf'
    - '{{ ansible_env.HOME }}/.vimrc'
    - '{{ ansible_env.HOME }}/.zshrc'
    - '{{ ansible_env.HOME }}/.ctags'
    - '{{ ansible_env.HOME }}/.gitconfig'
    - '{{ ansible_env.HOME }}/.config/libinput-gestures.conf'
    - '{{ ansible_env.HOME }}/.config/mpv/mpv.conf'
    - '{{ ansible_env.HOME }}/.config/keepassxc/keepassxc.ini'
    - '{{ ansible_env.HOME }}/.ssh/assh.yml'
  when: firstrun.changed

- name: link dotfiles
  file:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    state: link
  with_items:
    - {src: '{{ ansible_env.HOME }}/dotfiles/.ansible.cfg', dest: '{{ ansible_env.HOME }}/.ansible.cfg'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/.aliases', dest: '{{ ansible_env.HOME }}/.aliases'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/.bashrc', dest: '{{ ansible_env.HOME }}/.bashrc'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/.tmux.conf', dest: '{{ ansible_env.HOME }}/.tmux.conf'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/.vimrc', dest: '{{ ansible_env.HOME }}/.vimrc'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/.zshrc', dest: '{{ ansible_env.HOME }}/.zshrc'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/.ctags', dest: '{{ ansible_env.HOME }}/.ctags'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/libinput-gestures.conf', dest: '{{ ansible_env.HOME }}/.config/libinput-gestures.conf'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/mpv.conf', dest: '{{ ansible_env.HOME }}/.config/mpv/mpv.conf'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/systemd/syncthing.service', dest: '{{ ansible_env.HOME }}/.config/systemd/user/syncthing.service'}
    - {src: '{{ ansible_env.HOME }}/dotfiles/systemd/syncthing-proxy.service', dest: '{{ ansible_env.HOME }}/.config/systemd/user/syncthing-proxy.service'}
    - {src: '{{ ansible_env.HOME }}/Syncthing/Conf/keepassxc.ini', dest: '{{ ansible_env.HOME }}/.config/keepassxc/keepassxc.ini'}
    - {src: '{{ ansible_env.HOME }}/Syncthing/Conf/assh.yml', dest: '{{ ansible_env.HOME }}/.ssh/assh.yml'}
    - {src: '{{ ansible_env.HOME }}/Syncthing/Conf/.gitconfig', dest: '{{ ansible_env.HOME }}/.gitconfig'}
    - {src: '{{ ansible_env.HOME }}/Syncthing/Conf/.histfile', dest: '{{ ansible_env.HOME }}/.histfile'}
  when: firstrun.changed

- name: Load Gnome Keybindings (gsettings)
  shell: |
    dconf reset -f /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/;
    gsettings set org.gnome.settings-daemon.plugins.media-keys custom-keybindings "['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/', '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom1/','/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom2/','/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom3/','/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom4/','/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom5/']";
  when: firstrun.changed

- name: Load Gnome Keybindings and Terminal Settings (dconf)
  shell: |
    dconf load {{ item.key }} < {{ item.value }}
  with_items:
    - {key: /org/gnome/desktop/wm/keybindings/, value: '{{ ansible_env.HOME }}/dotfiles/gnome-shell-keybindings.conf'}
    - {key: /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/, value: '{{ ansible_env.HOME }}/dotfiles/gnome-keybindings.conf'}
    - {key: /org/gnome/terminal/, value: '{{ ansible_env.HOME }}/dotfiles/gnome-terminal.conf'}
    - {key: /org/gnome/desktop/app-folders/, value: '{{ ansible_env.HOME }}/dotfiles/gnome-folders.conf'}
  when: firstrun.changed

- name: Configure Dconf Options
  dconf:
    key: '{{ item.key }}'
    value: '{{ item.value }}'
    state: present
  with_items:
    - {key: /org/gnome/mutter/experimental-features, value: "['rt-scheduler']"}
    - {key: /org/gnome/desktop/input-sources/xkb-options, value: "['caps:ctrl_modifier']"}
    - {key: /org/gnome/desktop/interface/cursor-blink, value: 'false'}
    - {key: /org/gnome/desktop/privacy/disable-microphone, value: 'true'}
    - {key: /org/gnome/desktop/privacy/recent-files-max-age, value: '7'}
    - {key: /org/gnome/desktop/privacy/remove-old-temp-files, value: 'true'}
    - {key: /org/gnome/desktop/privacy/disable-camera, value: 'true'}
    - {key: /org/gnome/desktop/privacy/report-technical-problems, value: 'false'}
    - {key: /org/gnome/desktop/privacy/remove-old-trash-files, value: 'true'}
    - {key: /org/gnome/desktop/privacy/send-software-usage-stats, value: 'false'}
    - {key: /org/gnome/nautilus/preferences/show-create-link, value: 'true'}
    - {key: /org/gnome/nautilus/preferences/show-delete-permanently, value: 'true'}
    - {key: /org/gnome/desktop/interface/show-battery-percentage, value: 'true'}
    - {key: /org/gnome/nautilus/preferences/default-folder-viewer, value: "'list-view'"}
    - {key: /org/gnome/nautilus/list-view/default-visible-columns, value: "['name', 'size', 'type', 'owner', 'group', 'permissions', 'date_modified', 'starred', 'detailed_type']"}
    - {key: /org/gnome/desktop/wm/preferences/action-middle-click-titlebar, value: "'minimize'"}
