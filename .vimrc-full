filetype off                  " required
call plug#begin('~/.vim/plugged')
" utilities
Plug 'vim-airline/vim-airline'
Plug 'airblade/vim-gitgutter'
Plug 'junegunn/fzf'                                             " fuzzy find all the things
Plug 'junegunn/fzf.vim'                                         " fuzzy find all the things

" ALE
Plug 'w0rp/ale'
" Deoplete
Plug 'prabirshrestha/async.vim'
Plug 'prabirshrestha/asyncomplete.vim'
Plug 'prabirshrestha/asyncomplete-file.vim'
Plug 'prabirshrestha/asyncomplete-tags.vim'
Plug 'prabirshrestha/asyncomplete-buffer.vim'
Plug 'prabirshrestha/asyncomplete-lsp.vim'
Plug 'prabirshrestha/vim-lsp'
Plug 'wellle/tmux-complete.vim'                                 " Complete from text on other splits

" Lang Packs
Plug 'sheerun/vim-polyglot'                                     " Lang packs

" Theme
Plug 'flazz/vim-colorschemes'

call plug#end()                                                 " required
filetype plugin indent on                                       " required
let g:airline#extensions#tabline#enabled = 1
let g:airline#extensions#tabline#formatter = 'unique_tail'
let g:netrw_liststyle = 3
let g:netrw_winsize = 25

" Gitgutter
let g:gitgutter_grep = 'rg'
let g:gitgutter_max_signs = 1000

" Langs
let g:python_highlight_all=1
let g:ansible_yamlKeyName = 'yamlKey'
let g:ansible_attribute_highlight = 'ab'
let g:ansible_name_highlight = 'd'
let g:ansible_extra_keywords_highlight = 1
let g:ansible_normal_keywords_highlight = 'Define'
let g:ansible_with_keywords_highlight = 'Operator'

" ALE linter
let g:ale_enabled = 1
let g:ale_set_quickfix = 1
let g:ale_linters_explicit = 1
let g:ale_set_highlights = 0
let g:ale_fix_on_save = 1
let g:ale_fixers = {
            \ '*':['remove_trailing_lines', 'trim_whitespace'],
            \ 'sh':['shfmt'],
            \ 'xml':['xmllint'],
            \ 'python':['autopep8','isort']
            \}
let g:ale_linters = {
            \ 'asm': ['gcc'],
            \ 'c': ['gcc'],
            \ 'cpp': ['gcc'],
            \ 'sh':['shellcheck', 'shell'],
            \ 'python': ['python','pylint'],
            \ 'xml':['xmllint'],
            \ 'json':['jsonlint'],
            \ 'yaml':['yamllint'],
            \ 'ansible':['ansible-lint']
            \}

let $FZF_DEFAULT_COMMAND="rg --files --hidden"
let g:fzf_files_options = "--preview 'if file {1} | grep -i text; then highlight {1} --force -s molokai -O truecolor ; fi'"
let g:fzf_tags_command = 'ctags -R'
let g:fzf_action = {'alt-enter':'vsplit' }

""" Ctrl-C copy visual selection to clipboard
vnoremap <C-c> :'<,'>w !xclip -sel clip<CR><CR>
nnoremap <C-c> :bd<CR>

let mapleader = ' '
" leader y/p to use system clipboard
map <leader>y "+y
map <leader>p "+p
" Utility shortcuts with leader:
map <leader>t :Tags<CR>
map <leader>b :Files<CR>
map <leader>f :Rg<CR>
map <leader>\ :Lexplore<CR>
map <leader><Tab> :Buffers<CR>
map <leader>j :set ft=.jinja2<Left><Left><Left><Left><Left><Left><Left>

" Ctrl+L Format Code
" if not use the specific implementation
noremap <C-L> <Esc>:w<CR>:mkview<CR>gg=G<CR>:loadview<CR>
augroup autoformat_settings
    autocmd FileType c,cpp,java,typescript,javascript noremap <buffer> <C-L><Esc>:w<CR>:mkview<CR>:%!clang-format -style=Google %<CR>:loadview<CR>
    autocmd FileType sh noremap <buffer> <C-L> <Esc>:w<CR>:mkview<CR>:!beautysh -f %<CR>:e<CR>:loadview<CR>
    autocmd FileType json noremap <buffer> <C-L> <Esc>:w<CR>:mkview<CR>:%!jsonlint -f %<CR>:e<CR>:loadview<CR>
    autocmd FileType python noremap <buffer> <C-L> <Esc>:w<CR>:mkview<CR>:%!autopep8 %<CR>:w<CR>:!isort %<CR><CR>:e<CR>:loadview<CR>
augroup END
" navigate tabs Tab (fw) S-Tab (prev)
map <Tab> :bn<CR>
map <S-Tab> :bp<CR>
"map <C-c> :bp<bar>sp<bar>bn<bar>bd!<CR>
" " Resize split window horizontally and vertically
noremap <S-M-Up> :2winc+<cr>
noremap <S-M-Down> :2winc-<cr>
noremap <S-M-Left> :2winc<<cr>
noremap <S-M-Right> :2winc><cr>

set updatetime=500
set title nocompatible nowritebackup nobackup                    " required
set mouse=a                                                       " it's always useful
set undofile undolevels=1000 undodir=$HOME/.vim/undo              " Undo file and directory
set directory=$HOME/.vim/swap                                     " Custom swapfile directory
set path+=** wildmenu                                             " Recursive path Tab autocomplete
set hidden                                                        " change buffer without saving
set backspace=indent,eol,start                                    " http://vi.stackexchange.com/a/2163
set splitright splitbelow                                         " Open new splits to the right and bottom
set autoindent smartindent copyindent                             " always set autoindenting on
set smarttab expandtab shiftwidth=4 tabstop=4 softtabstop=4       " Four spaces for tabs everywhere
set hlsearch incsearch ignorecase smartcase                       " Highlight search results, ignore case if search is all lowercase
set nowrap number                                                 " play nicely with long lines
set nomodeline                                                    " protect against https://github.com/numirias/security/blob/master/doc/2019-06-04_ace-vim-neovim.md
let &colorcolumn=join(range(81,999),",")
syntax on
" play nicely with modern graphics
set encoding=utf8
set background=dark
colorscheme molokai
set termguicolors
highlight Normal guibg=#151515 guifg=#FFFFFF
highlight ColorColumn guibg=#101010
" Toggle Theme
map <silent> <C-e> :<C-u>call ToggleTheme()<CR>
function! ToggleTheme()
    if &background == 'light'
        set background=dark
        colorscheme molokai
        highlight Normal guibg=#151515 guifg=#FFFFFF
        highlight ColorColumn guibg=#101010
    else
        set background=light
        colorscheme xcode
    endif
endfunction

" Register completion files
au User asyncomplete_setup call asyncomplete#register_source(asyncomplete#sources#file#get_source_options({
    \ 'name': 'file',
    \ 'whitelist': ['*'],
    \ 'priority': 10,
    \ 'completor': function('asyncomplete#sources#file#completor')
    \ }))
" Register completion tags
au User asyncomplete_setup call asyncomplete#register_source(asyncomplete#sources#tags#get_source_options({
    \ 'name': 'tags',
    \ 'whitelist': ['*'],
    \ 'blacklist': ['c','cpp','python'],
    \ 'completor': function('asyncomplete#sources#tags#completor'),
    \ 'config': {
    \    'max_file_size': 50000000,
    \  },
    \ }))
" Register completion buffer
au User asyncomplete_setup call asyncomplete#register_source(asyncomplete#sources#buffer#get_source_options({
    \ 'name': 'buffer',
    \ 'whitelist': ['*'],
    \ 'blacklist': ['go'],
    \ 'completor': function('asyncomplete#sources#buffer#completor'),
    \ 'config': {
    \    'max_buffer_size': 5000000,
    \  },
    \ }))
" Register LSP python
au User lsp_setup call lsp#register_server({
    \ 'name': 'pyls',
    \ 'cmd': {server_info->['pyls']},
    \ 'whitelist': ['python'],
    \ })
" Register LSP C/C++/ASM...
au User lsp_setup call lsp#register_server({
    \ 'name': 'clangd',
    \ 'cmd': {server_info->['clangd']},
    \ 'whitelist': ['c','cpp','asm'],
    \ })
