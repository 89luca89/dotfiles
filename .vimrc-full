filetype off                                        " required
call plug#begin('~/.vim/plugged')
" vim tmux navigator
Plug 'christoomey/vim-tmux-navigator'
" utilities
Plug 'junegunn/fzf', { 'dir': '~/.local/bin/fzf', 'do': './install --all' }
Plug 'junegunn/fzf.vim'                             " fuzzy find all the things
Plug 'ap/vim-buftabline'
" Git
Plug 'airblade/vim-gitgutter'
Plug 'tpope/vim-fugitive'
"" Lang Packs
Plug 'sheerun/vim-polyglot', { 'do': './build' }    " Lang packs
"" CTags (for non-lsp langs)
Plug 'ludovicchabant/vim-gutentags'
" vim-lsp + asyncomplete
Plug 'prabirshrestha/async.vim'
Plug 'prabirshrestha/asyncomplete.vim'
Plug 'prabirshrestha/asyncomplete-buffer.vim'
Plug 'prabirshrestha/asyncomplete-file.vim'
Plug 'prabirshrestha/asyncomplete-tags.vim'
Plug 'prabirshrestha/asyncomplete-lsp.vim'
Plug 'prabirshrestha/vim-lsp'
" Aestetics
Plug 'rakr/vim-one'

call plug#end()                                     " required
"
filetype plugin indent on                           " required
syntax on
" Dynamic split resize
autocmd VimResized * :wincmd =
" Remove trailing whitespaces and lines
autocmd BufWritePre * silent! :%s/\s\+$//e
autocmd BufWritePre * silent! :%s/\($\n\s*\)\+\%$//e
" Set cursorline ONLY on active buffer
augroup CursorLine
    au!
    au VimEnter,WinEnter,BufWinEnter * setlocal cursorline
    au WinLeave * setlocal nocursorline
augroup END
let g:buftabline_indicators = 1
let g:buftabline_separators = 1
let g:buftabline_plug_max   = 0
" Tags
"let g:gutentags_project_root = ['package.json', '.git', 'Makefile', '.project']
let g:gutentags_project_root = ['Makefile', '.project', '.git', '.hg', '.svn', '.bzr', '_darcs', '_darcs', '_FOSSIL_', '.fslckout' ]
let g:gutentags_cache_dir = expand('~/.cache/vim/ctags/')
let g:gutentags_generate_on_new     = 1
let g:gutentags_generate_on_missing = 1
let g:gutentags_generate_on_write   = 1
let g:gutentags_generate_on_empty_buffer = 0
"
let g:python_host_prog  = '/usr/bin/python2'
let g:python3_host_prog = '/usr/bin/python3'
" Netrw
let g:netrw_banner          = 0
let g:netrw_browse_split    = 4
let g:netrw_liststyle       = 3
let g:netrw_winsize         = -28
" Langs
let g:ansible_attribute_highlight   = 'ab'
let g:ansible_extra_keywords_highlight  = 1
let g:ansible_name_highlight = 'd'
let g:ansible_normal_keywords_highlight = 'Define'
let g:ansible_with_keywords_highlight = 'Operator'
let g:ansible_yamlKeyName   = 'yamlKey'
let g:go_highlight_build_constraints    = 1
let g:go_highlight_extra_types  = 1
let g:go_highlight_fields       = 1
let g:go_highlight_functions    = 1
let g:go_highlight_methods      = 1
let g:go_highlight_operators    = 1
let g:go_highlight_structs      = 1
let g:go_highlight_types        = 1
let g:python_highlight_all  = 1
" Asyncomplete + LSP
set completeopt=noinsert,noselect,menu,popup
set completepopup=align:menu,border:off,highlight:Pmenu
let g:asyncomplete_auto_completeopt  = 0
let g:asyncomplete_remove_duplicates = 1
let g:asyncomplete_smart_completion  = 1
let g:lsp_auto_enable   = 1
let g:lsp_diagnostics_echo_cursor    = 1
let g:lsp_diagnostics_enabled        = 1
let g:lsp_highlight_references_enabled = 1
let g:lsp_highlights_enabled         = 1
let g:lsp_log_file  = expand('/dev/null')
let g:lsp_log_verbose          = 0
let g:lsp_preview_max_width    = 100
let g:lsp_semantic_enabled     = 1
let g:lsp_signs_enabled        = 1
let g:lsp_virtual_text_enabled = 1
call asyncomplete#register_source(asyncomplete#sources#buffer#get_source_options({
            \ 'name': 'buffer',
            \ 'whitelist': ['*'],
            \ 'completor': function('asyncomplete#sources#buffer#completor'),
            \ }))
call asyncomplete#register_source(asyncomplete#sources#file#get_source_options({
            \ 'name': 'file',
            \ 'whitelist': ['*'],
            \ 'completor': function('asyncomplete#sources#file#completor')
            \ }))
call asyncomplete#register_source(asyncomplete#sources#tags#get_source_options({
            \ 'name': 'tags',
            \ 'whitelist': ['*'],
            \ 'completor': function('asyncomplete#sources#tags#completor'),
            \ }))
call lsp#register_server({
            \ 'name': 'clangd',
            \ 'whitelist': ['c', 'cpp'],
            \ 'cmd': {server_info->['clangd', '-background-index']},
            \ })
call lsp#register_server({
            \ 'name': 'gopls',
            \ 'whitelist': ['go'],
            \ 'cmd': {server_info->['gopls']},
            \ })
call lsp#register_server({
            \ 'name': 'golangci-lint-langserver',
            \ 'whitelist': ['go'],
            \ 'cmd': {server_info->['golangci-lint-langserver']},
            \ 'initialization_options': {'command': ['golangci-lint', 'run',
            \'--fast', '--enable-all',
            \'--disable', 'funlen,gomnd,gochecknoglobals', '--out-format', 'json']},
            \ })
call lsp#register_server({
            \ 'name': 'pyls',
            \ 'whitelist': ['python'],
            \ 'cmd': {server_info->['pyls']},
            \ })
call lsp#register_server({
            \ 'name': 'efm-langserver',
            \ 'whitelist': [
            \'json',
            \'xml',
            \'yaml',
            \'yaml.ansible',
            \'sh',
            \'python',
            \'go'],
            \ 'cmd': {server_info->['efm-langserver', '-c=/home/luca-linux/dotfiles/efm-config.yml']},
            \ })
" FZF fuzzy
let g:fzf_action = {'alt-enter':'vsplit' }
let g:fzf_files_options = "--preview 'if file {1} | grep -Ei \"text|JSON\"; then cat {1} ; fi'"
"""""""""""""""""""""
"""     Shortcuts   "
" Leader map
let mapleader = ' '
" toggle file explorer
nnoremap <C-n> :Lexplore<CR>
" leader y/p to use system clipboard, C-c in vmode for xclip
map <leader>y "+y
map <leader>p "+p
vnoremap <C-c> :'<,'>w !xclip -sel clip<CR><CR>
" vim-tmux-navigator shortcuts
let g:tmux_navigator_no_mappings    = 1
inoremap <silent> <M-Down>  <Esc>:<C-u>TmuxNavigateDown<CR>
inoremap <silent> <M-Left>  <Esc>:<C-u>TmuxNavigateLeft<CR>
inoremap <silent> <M-Right> <Esc>:<C-u>TmuxNavigateRight<CR>
inoremap <silent> <M-Up>    <Esc>:<C-u>TmuxNavigateUp<CR>
nnoremap <silent> <M-Down>  :<C-u>TmuxNavigateDown<CR>
nnoremap <silent> <M-Left>  :<C-u>TmuxNavigateLeft<CR>
nnoremap <silent> <M-Right> :<C-u>TmuxNavigateRight<CR>
nnoremap <silent> <M-Up>    :<C-u>TmuxNavigateUp<CR>
" navigate tabs Tab (fw) S-Tab (prev)
map <Tab>   :<C-u>bn!<CR>
map <S-Tab> :<C-u>bp!<CR>
" C-c close buffer
nnoremap <C-c> :<C-u>bp<BAR>sp<BAR>bn<BAR>bd<CR>
" " Resize split window horizontally and vertically
noremap <S-M-Down>  :<C-u>2winc-<CR>
noremap <S-M-Left>  :<C-u>2winc<<CR>
noremap <S-M-Right> :<C-u>2winc><CR>
noremap <S-M-Up>    :<C-u>2winc+<CR>
" Utility shortcuts with leader:
nnoremap <leader><Tab>  :<C-u>Buffers<CR>
nnoremap <leader>b      :<C-u>Files<CR>
nnoremap <leader>f      :<C-u>Rg<CR>
" Utility for Markdown and Ansible
nnoremap <leader>j  :<C-u>set ft=
" Default IDE-Style keybindings
nnoremap <leader>gd :<C-u>GitGutterPreviewHunk<CR>
nnoremap <leader>gu :<C-u>GitGutterUndoHunk<CR>
nnoremap <leader>gs :<C-u>GFiles?<CR>
nnoremap <leader>gg :<C-u>GitGutterLineHighlightsToggle<CR>
nnoremap <leader>m  :<C-u>Commands<CR>
nnoremap <leader>t  :<C-u>Tags<CR>
nnoremap <leader>x  :<C-u>Rg <c-r>=expand("<cword>")<CR><CR>
nnoremap <leader>e  :<C-u>lopen<CR>
nnoremap <leader>D  <C-T>
nnoremap <leader>d  :<C-u>vert stag <c-r>=expand("<cword>")<CR><CR>
nnoremap <leader>r  :<C-u>!grep -rl <c-r>=expand("<cword>")<CR><BAR>xargs sed -i 's/<c-r>=expand("<cword>")<CR>//g'<Left><Left><Left>
nnoremap <leader>l  :<C-u>mkview<CR>ggVG=:<C-u>loadview<CR>
vnoremap <leader>l  =
" LSP keybindings overriding the previous
augroup lspbindings
    autocmd! lspbindings
    " IDE-like keybindings
    autocmd Filetype yaml,yaml.ansible,sh,c,cpp,python,go,json,xml nnoremap K  :<C-u>call popup_clear()<BAR>LspHover<CR>
    autocmd Filetype yaml,yaml.ansible,sh,c,cpp,python,go,json,xml nnoremap <leader>e :<C-u>LspDocumentDiagnostics<CR>
    autocmd Filetype yaml,yaml.ansible,sh,c,cpp,python,go,json,xml nnoremap <leader>h :<C-u>call popup_clear()<BAR>LspPeekDefinition<CR>
    autocmd Filetype yaml,yaml.ansible,sh,c,cpp,python,go,json,xml nnoremap <leader>td :<C-u>call popup_clear()<BAR>LspPeekTypeDefinition<CR>
    autocmd Filetype yaml,yaml.ansible,sh,c,cpp,python,go,json,xml nnoremap <leader>d :<C-u>LspDefinition<CR>
    autocmd Filetype yaml,yaml.ansible,sh,c,cpp,python,go,json,xml nnoremap <leader>r :<C-u>LspRename<CR>
    autocmd Filetype yaml,yaml.ansible,sh,c,cpp,python,go,json,xml nnoremap <leader>l :<C-u>LspDocumentFormat<CR>
    autocmd Filetype yaml,yaml.ansible,sh,c,cpp,python,go,json,xml vnoremap <leader>l :<C-u>LspDocumentRangeFormat<CR>
augroup end
" Miscellaneous
let &colorcolumn=join(range(81,250),",")
set autoindent backspace=indent,eol,start
set directory=$HOME/.vim/swap                                     " Custom swapfile directory
set expandtab shiftwidth=4 tabstop=4 softtabstop=4                " Four spaces for tabs everywhere
set mouse=a                                                       " it's always useful
set nowrap number nomodeline cursorline relativenumber
set path+=**                                                      " Recursive path Tab autocomplete
set smartindent copyindent                                        " always set autoindenting on
set smarttab incsearch sessionoptions-=options viewoptions-=options
set splitright splitbelow                                         " Open new splits to the right and bottom
set title nocompatible nowritebackup nobackup
set undofile undolevels=1000 undodir=$HOME/.vim/undo              " Undo file and directory
set updatetime=1000 ttyfast lazyredraw t_Co=16
"""""""""
" Theming
set background=dark
set termguicolors
let g:one_allow_italics = 1
colorscheme one
autocmd Syntax,InsertEnter * syntax match myFunction /\<\k\+\ze(/
highlight link myFunction   Function
highlight StatusLine guifg=white guibg=#555555
highlight StatusLineNC guibg=white guifg=#282c34
" Toggle Theme
map <silent> <C-e> :<C-u>call ToggleTheme()<CR>
function! ToggleTheme()
    if &background == 'light'
        set background=dark
        highlight StatusLine guifg=white guibg=#555555
        highlight StatusLineNC guibg=white guifg=#282c34
    else
        set background=light
    endif
endfunction
